# Epic 4, Story 4.4: Enterprise Customization Engine

## BMAD Framework Implementation

### B - Business Value & Context

**Story Overview:**
Implement an advanced customization engine that enables enterprise clients to fully brand, configure, and customize their Seiketsu AI voice agent instances while maintaining security and compliance standards established in Stories 4.1-4.3.

**Business Impact:**
- **Revenue Growth**: Enable white-label licensing ($50K-$500K per enterprise deployment)
- **Market Expansion**: Allow partners to resell customized instances under their brand
- **Customer Retention**: Provide deep customization reduces churn by 40%
- **Competitive Advantage**: Most voice AI platforms lack enterprise-grade customization
- **Compliance Adherence**: Customizations maintain SOC 2, GDPR, and security standards

**User Personas:**
- **Enterprise IT Directors**: Need branded, compliant voice solutions
- **Channel Partners**: Require white-label deployment capabilities
- **Tenant Administrators**: Want to customize workflows and branding
- **Compliance Officers**: Must ensure customizations meet regulatory requirements

**Success Metrics:**
- Deployment time for new enterprise instance: <4 hours
- Customization options available: 50+ configurable elements
- Template library growth: 10 industry-specific templates
- Customer satisfaction with customization: >90%
- Compliance maintenance across all customizations: 100%

### M - Minimal Scope Definition

**Core Deliverables (2-4 hours):**
1. **Customization Engine Architecture** (45 min)
   - Multi-layer configuration system
   - Template-based deployment engine
   - Brand asset management system

2. **White-Label Infrastructure** (60 min)
   - Custom domain mapping
   - Brand injection pipeline
   - Theme configuration engine

3. **Workflow Customization System** (45 min)
   - Configurable conversation flows
   - Custom prompt templates
   - Voice personality tuning

4. **Template Management Platform** (30 min)
   - Industry-specific templates
   - Rapid deployment system
   - Configuration validation

**Out of Scope:**
- Advanced AI model fine-tuning (Epic 5)
- Multi-language localization (Epic 6)
- Complex integration marketplace (Epic 7)
- Performance optimization for 1M+ users (Epic 8)

**Dependencies:**
- Story 4.1: SOC 2 compliance framework
- Story 4.2: Data encryption and protection
- Story 4.3: Security monitoring and audit trails
- Existing multi-tenant architecture
- Supabase tenant isolation

### A - Architecture & Technical Design

**System Architecture:**

```
┌─────────────────────────────────────────────────────────────┐
│                    CUSTOMIZATION ENGINE                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Brand Engine  │  │ Workflow Engine │  │ Voice Engine │ │
│  │   - Themes      │  │ - Conversation  │  │ - Personality│ │
│  │   - Assets      │  │ - Prompts       │  │ - Voice Model│ │
│  │   - Domains     │  │ - Flows         │  │ - TTS Config │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              TEMPLATE MANAGEMENT                        │ │
│  │  - Industry Templates  - Deployment Pipeline           │ │
│  │  - Configuration Sets  - Validation Engine             │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │               COMPLIANCE LAYER                          │ │
│  │  - Security Validation  - Audit Trail                  │ │
│  │  - Policy Enforcement  - Change Management             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**Database Schema Extensions:**

```sql
-- Tenant Customization Configuration
CREATE TABLE tenant_customizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    category VARCHAR(50) NOT NULL, -- 'branding', 'workflow', 'voice'
    config_key VARCHAR(100) NOT NULL,
    config_value JSONB NOT NULL,
    version INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    compliance_validated BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(tenant_id, category, config_key)
);

-- Template Library
CREATE TABLE customization_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    industry VARCHAR(50),
    template_type VARCHAR(50), -- 'full', 'branding', 'workflow'
    config_schema JSONB NOT NULL,
    default_values JSONB NOT NULL,
    is_public BOOLEAN DEFAULT false,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Brand Assets Storage
CREATE TABLE tenant_brand_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    asset_type VARCHAR(50) NOT NULL, -- 'logo', 'favicon', 'background'
    asset_url TEXT NOT NULL,
    asset_metadata JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Custom Domain Mapping
CREATE TABLE tenant_domains (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    domain VARCHAR(255) UNIQUE NOT NULL,
    subdomain VARCHAR(100),
    ssl_enabled BOOLEAN DEFAULT true,
    is_primary BOOLEAN DEFAULT false,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'active', 'failed'
    created_at TIMESTAMP DEFAULT NOW()
);
```

**Core Components:**

```python
# apps/api/app/services/customization_engine.py
from typing import Dict, Any, List, Optional
from sqlalchemy.orm import Session
from app.models.tenant import TenantCustomization, CustomizationTemplate
import json
import jsonschema

class CustomizationEngine:
    def __init__(self, db: Session):
        self.db = db
        self.validators = {
            'branding': self._validate_branding_config,
            'workflow': self._validate_workflow_config,
            'voice': self._validate_voice_config
        }
    
    async def apply_customization(
        self, 
        tenant_id: str, 
        category: str, 
        config: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Apply customization with validation and compliance checking"""
        
        # Validate configuration
        if not await self._validate_configuration(category, config):
            raise ValueError(f"Invalid {category} configuration")
        
        # Check compliance requirements
        if not await self._check_compliance(tenant_id, category, config):
            raise ValueError(f"Configuration violates compliance requirements")
        
        # Apply customization
        customization = TenantCustomization(
            tenant_id=tenant_id,
            category=category,
            config_key=config.get('key'),
            config_value=config,
            compliance_validated=True
        )
        
        self.db.add(customization)
        self.db.commit()
        
        # Trigger deployment pipeline
        await self._deploy_customization(tenant_id, category, config)
        
        return {"status": "applied", "customization_id": customization.id}
    
    async def deploy_from_template(
        self, 
        tenant_id: str, 
        template_id: str,
        overrides: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """Deploy tenant customization from template"""
        
        template = self.db.query(CustomizationTemplate).filter(
            CustomizationTemplate.id == template_id
        ).first()
        
        if not template:
            raise ValueError("Template not found")
        
        # Merge template defaults with overrides
        config = {**template.default_values}
        if overrides:
            config.update(overrides)
        
        # Apply all customizations from template
        results = []
        for category, category_config in config.items():
            result = await self.apply_customization(
                tenant_id, category, category_config
            )
            results.append(result)
        
        return {"status": "deployed", "results": results}
    
    async def _validate_configuration(
        self, 
        category: str, 
        config: Dict[str, Any]
    ) -> bool:
        """Validate configuration against schema"""
        if category in self.validators:
            return await self.validators[category](config)
        return True
    
    async def _validate_branding_config(self, config: Dict[str, Any]) -> bool:
        """Validate branding configuration"""
        schema = {
            "type": "object",
            "properties": {
                "primary_color": {"type": "string", "pattern": "^#[0-9A-Fa-f]{6}$"},
                "secondary_color": {"type": "string", "pattern": "^#[0-9A-Fa-f]{6}$"},
                "logo_url": {"type": "string", "format": "uri"},
                "company_name": {"type": "string", "maxLength": 100},
                "theme": {"type": "string", "enum": ["light", "dark", "auto"]}
            },
            "required": ["primary_color", "company_name"]
        }
        
        try:
            jsonschema.validate(config, schema)
            return True
        except jsonschema.ValidationError:
            return False
    
    async def _check_compliance(
        self, 
        tenant_id: str, 
        category: str, 
        config: Dict[str, Any]
    ) -> bool:
        """Check if customization meets compliance requirements"""
        # Implement compliance checks based on Stories 4.1-4.3
        return True
    
    async def _deploy_customization(
        self, 
        tenant_id: str, 
        category: str, 
        config: Dict[str, Any]
    ) -> None:
        """Deploy customization to tenant environment"""
        # Implement deployment pipeline
        pass

# Brand Engine Component
class BrandEngine:
    def __init__(self, db: Session):
        self.db = db
    
    async def apply_theme(
        self, 
        tenant_id: str, 
        theme_config: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Apply custom theme to tenant"""
        
        # Generate CSS variables
        css_vars = self._generate_css_variables(theme_config)
        
        # Store brand configuration
        brand_config = TenantCustomization(
            tenant_id=tenant_id,
            category='branding',
            config_key='theme',
            config_value={
                'css_variables': css_vars,
                'theme_config': theme_config
            }
        )
        
        self.db.add(brand_config)
        self.db.commit()
        
        return {"css_variables": css_vars, "theme_id": brand_config.id}
    
    def _generate_css_variables(self, theme_config: Dict[str, Any]) -> Dict[str, str]:
        """Generate CSS custom properties from theme config"""
        return {
            '--primary-color': theme_config.get('primary_color', '#007bff'),
            '--secondary-color': theme_config.get('secondary_color', '#6c757d'),
            '--accent-color': theme_config.get('accent_color', '#28a745'),
            '--background-color': theme_config.get('background_color', '#ffffff'),
            '--text-color': theme_config.get('text_color', '#212529'),
            '--font-family': theme_config.get('font_family', 'Inter, sans-serif')
        }

# Workflow Engine Component
class WorkflowEngine:
    def __init__(self, db: Session):
        self.db = db
    
    async def customize_conversation_flow(
        self, 
        tenant_id: str, 
        flow_config: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Customize conversation workflows"""
        
        # Validate flow configuration
        if not self._validate_flow_config(flow_config):
            raise ValueError("Invalid flow configuration")
        
        # Store workflow customization
        workflow_config = TenantCustomization(
            tenant_id=tenant_id,
            category='workflow',
            config_key='conversation_flow',
            config_value=flow_config
        )
        
        self.db.add(workflow_config)
        self.db.commit()
        
        return {"status": "applied", "flow_id": workflow_config.id}
    
    def _validate_flow_config(self, flow_config: Dict[str, Any]) -> bool:
        """Validate conversation flow configuration"""
        required_keys = ['greeting', 'intent_mapping', 'fallback_responses']
        return all(key in flow_config for key in required_keys)
```

**Frontend Components:**

```typescript
// apps/web/app/admin/customization/page.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

interface CustomizationConfig {
  branding: {
    primary_color: string;
    secondary_color: string;
    logo_url: string;
    company_name: string;
    theme: 'light' | 'dark' | 'auto';
  };
  workflow: {
    greeting: string;
    intent_mapping: Record<string, string>;
    fallback_responses: string[];
  };
  voice: {
    personality: string;
    voice_model: string;
    speech_rate: number;
  };
}

export default function CustomizationPage() {
  const [config, setConfig] = useState<CustomizationConfig>({
    branding: {
      primary_color: '#007bff',
      secondary_color: '#6c757d',
      logo_url: '',
      company_name: '',
      theme: 'light'
    },
    workflow: {
      greeting: 'Hello! How can I assist you today?',
      intent_mapping: {},
      fallback_responses: ['I apologize, but I didn\'t understand that. Could you please rephrase?']
    },
    voice: {
      personality: 'professional',
      voice_model: 'eleven_monolingual_v1',
      speech_rate: 1.0
    }
  });

  const [isLoading, setIsLoading] = useState(false);
  const [previewMode, setPreviewMode] = useState(false);

  const handleApplyCustomization = async (category: keyof CustomizationConfig) => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/customization/apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category,
          config: config[category]
        })
      });

      if (response.ok) {
        // Show success message
      }
    } catch (error) {
      console.error('Failed to apply customization:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const handlePreviewToggle = () => {
    setPreviewMode(!previewMode);
    if (!previewMode) {
      // Apply preview styles
      document.documentElement.style.setProperty('--primary-color', config.branding.primary_color);
      document.documentElement.style.setProperty('--secondary-color', config.branding.secondary_color);
    } else {
      // Reset to default styles
      document.documentElement.style.removeProperty('--primary-color');
      document.documentElement.style.removeProperty('--secondary-color');
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-3xl font-bold">Customization Engine</h1>
          <div className="flex gap-4">
            <Button 
              variant="outline" 
              onClick={handlePreviewToggle}
            >
              {previewMode ? 'Exit Preview' : 'Preview Changes'}
            </Button>
            <Button onClick={() => handleApplyCustomization('branding')}>
              Apply All Changes
            </Button>
          </div>
        </div>

        <Tabs defaultValue="branding" className="space-y-6">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="branding">Branding</TabsTrigger>
            <TabsTrigger value="workflow">Workflow</TabsTrigger>
            <TabsTrigger value="voice">Voice</TabsTrigger>
            <TabsTrigger value="templates">Templates</TabsTrigger>
          </TabsList>

          <TabsContent value="branding">
            <Card>
              <CardHeader>
                <CardTitle>Brand Customization</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="company-name">Company Name</Label>
                      <Input
                        id="company-name"
                        value={config.branding.company_name}
                        onChange={(e) => setConfig(prev => ({
                          ...prev,
                          branding: { ...prev.branding, company_name: e.target.value }
                        }))}
                        placeholder="Your Company Name"
                      />
                    </div>
                    
                    <div>
                      <Label htmlFor="primary-color">Primary Color</Label>
                      <div className="flex gap-2">
                        <Input
                          id="primary-color"
                          type="color"
                          value={config.branding.primary_color}
                          onChange={(e) => setConfig(prev => ({
                            ...prev,
                            branding: { ...prev.branding, primary_color: e.target.value }
                          }))}
                          className="w-16 h-10"
                        />
                        <Input
                          value={config.branding.primary_color}
                          onChange={(e) => setConfig(prev => ({
                            ...prev,
                            branding: { ...prev.branding, primary_color: e.target.value }
                          }))}
                          placeholder="#007bff"
                        />
                      </div>
                    </div>

                    <div>
                      <Label htmlFor="secondary-color">Secondary Color</Label>
                      <div className="flex gap-2">
                        <Input
                          id="secondary-color"
                          type="color"
                          value={config.branding.secondary_color}
                          onChange={(e) => setConfig(prev => ({
                            ...prev,
                            branding: { ...prev.branding, secondary_color: e.target.value }
                          }))}
                          className="w-16 h-10"
                        />
                        <Input
                          value={config.branding.secondary_color}
                          onChange={(e) => setConfig(prev => ({
                            ...prev,
                            branding: { ...prev.branding, secondary_color: e.target.value }
                          }))}
                          placeholder="#6c757d"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="logo-url">Logo URL</Label>
                      <Input
                        id="logo-url"
                        value={config.branding.logo_url}
                        onChange={(e) => setConfig(prev => ({
                          ...prev,
                          branding: { ...prev.branding, logo_url: e.target.value }
                        }))}
                        placeholder="https://example.com/logo.png"
                      />
                    </div>

                    {/* Live Preview */}
                    <div className="border rounded-lg p-4 bg-white">
                      <h3 className="font-semibold mb-4">Live Preview</h3>
                      <div 
                        className="p-4 rounded-lg"
                        style={{
                          backgroundColor: config.branding.primary_color + '10',
                          borderColor: config.branding.primary_color
                        }}
                      >
                        <div className="flex items-center gap-3">
                          {config.branding.logo_url && (
                            <img 
                              src={config.branding.logo_url} 
                              alt="Logo" 
                              className="w-8 h-8 object-contain"
                            />
                          )}
                          <span 
                            className="font-bold"
                            style={{ color: config.branding.primary_color }}
                          >
                            {config.branding.company_name || 'Your Company'}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <Button 
                  onClick={() => handleApplyCustomization('branding')}
                  disabled={isLoading}
                  className="w-full"
                >
                  {isLoading ? 'Applying...' : 'Apply Branding'}
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="workflow">
            <Card>
              <CardHeader>
                <CardTitle>Workflow Customization</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label htmlFor="greeting">Custom Greeting</Label>
                  <Input
                    id="greeting"
                    value={config.workflow.greeting}
                    onChange={(e) => setConfig(prev => ({
                      ...prev,
                      workflow: { ...prev.workflow, greeting: e.target.value }
                    }))}
                    placeholder="Hello! How can I assist you today?"
                  />
                </div>

                <Button 
                  onClick={() => handleApplyCustomization('workflow')}
                  disabled={isLoading}
                >
                  {isLoading ? 'Applying...' : 'Apply Workflow'}
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="voice">
            <Card>
              <CardHeader>
                <CardTitle>Voice Customization</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label htmlFor="personality">Voice Personality</Label>
                  <select
                    id="personality"
                    value={config.voice.personality}
                    onChange={(e) => setConfig(prev => ({
                      ...prev,
                      voice: { ...prev.voice, personality: e.target.value }
                    }))}
                    className="w-full p-2 border rounded-md"
                  >
                    <option value="professional">Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="authoritative">Authoritative</option>
                    <option value="casual">Casual</option>
                  </select>
                </div>

                <Button 
                  onClick={() => handleApplyCustomization('voice')}
                  disabled={isLoading}
                >
                  {isLoading ? 'Applying...' : 'Apply Voice Settings'}
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="templates">
            <TemplateManagement />
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

// Template Management Component
function TemplateManagement() {
  const [templates, setTemplates] = useState([]);
  const [selectedTemplate, setSelectedTemplate] = useState(null);

  useEffect(() => {
    // Load available templates
    fetchTemplates();
  }, []);

  const fetchTemplates = async () => {
    try {
      const response = await fetch('/api/customization/templates');
      const data = await response.json();
      setTemplates(data.templates);
    } catch (error) {
      console.error('Failed to fetch templates:', error);
    }
  };

  const deployTemplate = async (templateId: string) => {
    try {
      const response = await fetch('/api/customization/deploy-template', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ template_id: templateId })
      });

      if (response.ok) {
        // Show success message
      }
    } catch (error) {
      console.error('Failed to deploy template:', error);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Template Library</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {templates.map((template: any) => (
            <div key={template.id} className="border rounded-lg p-4">
              <h3 className="font-semibold">{template.name}</h3>
              <p className="text-sm text-gray-600 mt-2">{template.description}</p>
              <p className="text-xs text-blue-600 mt-1">Industry: {template.industry}</p>
              <Button 
                className="mt-4 w-full" 
                size="sm"
                onClick={() => deployTemplate(template.id)}
              >
                Deploy Template
              </Button>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

### D - Delivery & Testing Plan

**Implementation Timeline (2-4 hours total):**

**Phase 1: Core Engine Setup (45 minutes)**
- [ ] Create database schema for customizations (10 min)
- [ ] Implement CustomizationEngine base class (15 min)
- [ ] Add configuration validation system (10 min)
- [ ] Set up compliance checking integration (10 min)

**Phase 2: White-Label Infrastructure (60 minutes)**
- [ ] Implement BrandEngine with theme generation (20 min)
- [ ] Add custom domain mapping system (15 min)
- [ ] Create brand asset management (15 min)
- [ ] Build CSS variable injection system (10 min)

**Phase 3: Workflow Customization (45 minutes)**
- [ ] Implement WorkflowEngine for conversation flows (20 min)
- [ ] Add prompt template customization (15 min)
- [ ] Create voice personality configuration (10 min)

**Phase 4: Template System (30 minutes)**
- [ ] Create template management infrastructure (15 min)
- [ ] Add industry-specific template library (10 min)
- [ ] Implement template deployment pipeline (5 min)

**Test Cases:**

```python
# Test Suite for Customization Engine
import pytest
from app.services.customization_engine import CustomizationEngine, BrandEngine, WorkflowEngine

class TestCustomizationEngine:
    def test_branding_customization_application(self):
        """Test applying branding customization with validation"""
        engine = CustomizationEngine(db_session)
        
        branding_config = {
            "primary_color": "#ff6b35",
            "secondary_color": "#004e89",
            "company_name": "AcmeCorp Real Estate",
            "logo_url": "https://acmecorp.com/logo.png",
            "theme": "light"
        }
        
        result = await engine.apply_customization(
            tenant_id="test-tenant-123",
            category="branding",
            config=branding_config
        )
        
        assert result["status"] == "applied"
        assert "customization_id" in result
        
        # Verify configuration stored correctly
        customization = db_session.query(TenantCustomization).filter(
            TenantCustomization.tenant_id == "test-tenant-123",
            TenantCustomization.category == "branding"
        ).first()
        
        assert customization is not None
        assert customization.config_value["primary_color"] == "#ff6b35"
        assert customization.compliance_validated == True

    def test_workflow_customization_with_real_estate_flows(self):
        """Test customizing conversation flows for real estate"""
        engine = WorkflowEngine(db_session)
        
        real_estate_flow = {
            "greeting": "Hi! I'm your AI real estate assistant. Are you looking to buy, sell, or rent?",
            "intent_mapping": {
                "property_search": "Let me help you find the perfect property. What's your budget range?",
                "property_valuation": "I can provide a market analysis for your property. What's the address?",
                "schedule_viewing": "I'll connect you with an agent to schedule a viewing."
            },
            "fallback_responses": [
                "I specialize in real estate. Could you tell me if you're interested in buying, selling, or renting?",
                "Let me connect you with a human agent who can better assist with that specific request."
            ]
        }
        
        result = await engine.customize_conversation_flow(
            tenant_id="realestate-tenant-456",
            flow_config=real_estate_flow
        )
        
        assert result["status"] == "applied"

    def test_template_deployment_for_enterprise_client(self):
        """Test deploying enterprise template with overrides"""
        engine = CustomizationEngine(db_session)
        
        # Create test template
        template = CustomizationTemplate(
            name="Enterprise Real Estate",
            industry="real_estate",
            template_type="full",
            default_values={
                "branding": {
                    "primary_color": "#2c5aa0",
                    "secondary_color": "#f8f9fa",
                    "theme": "professional"
                },
                "workflow": {
                    "greeting": "Welcome to our enterprise real estate platform.",
                    "intent_mapping": {"lead_capture": "Let me collect your information."}
                }
            }
        )
        db_session.add(template)
        db_session.commit()
        
        # Deploy with custom overrides
        overrides = {
            "branding": {
                "company_name": "Elite Properties Group",
                "primary_color": "#1a365d"
            }
        }
        
        result = await engine.deploy_from_template(
            tenant_id="elite-properties-789",
            template_id=template.id,
            overrides=overrides
        )
        
        assert result["status"] == "deployed"
        assert len(result["results"]) >= 2  # branding + workflow

    def test_white_label_domain_configuration(self):
        """Test custom domain mapping for white-label deployment"""
        from app.services.domain_manager import DomainManager
        
        domain_manager = DomainManager(db_session)
        
        result = await domain_manager.configure_custom_domain(
            tenant_id="whitelabel-client-101",
            domain="voice.clientcompany.com",
            ssl_enabled=True
        )
        
        assert result["status"] == "configured"
        assert result["domain"] == "voice.clientcompany.com"

    def test_compliance_validation_during_customization(self):
        """Test that customizations maintain compliance standards"""
        engine = CustomizationEngine(db_session)
        
        # Test with potentially non-compliant configuration
        risky_config = {
            "data_retention": "indefinite",  # Should trigger compliance check
            "third_party_integrations": ["unapproved-service"],
            "encryption_level": "basic"
        }
        
        with pytest.raises(ValueError, match="Configuration violates compliance"):
            await engine.apply_customization(
                tenant_id="test-tenant-999",
                category="data_handling",
                config=risky_config
            )

    def test_css_variable_generation_for_themes(self):
        """Test CSS variable generation from theme configuration"""
        brand_engine = BrandEngine(db_session)
        
        theme_config = {
            "primary_color": "#e63946",
            "secondary_color": "#f1faee",
            "accent_color": "#a8dadc",
            "background_color": "#1d3557",
            "text_color": "#f1faee",
            "font_family": "Roboto, sans-serif"
        }
        
        result = await brand_engine.apply_theme(
            tenant_id="themed-tenant-202",
            theme_config=theme_config
        )
        
        css_vars = result["css_variables"]
        assert css_vars["--primary-color"] == "#e63946"
        assert css_vars["--font-family"] == "Roboto, sans-serif"

    def test_performance_with_multiple_concurrent_customizations(self):
        """Test system performance with multiple simultaneous customizations"""
        import asyncio
        
        engine = CustomizationEngine(db_session)
        
        async def apply_test_customization(tenant_id: str):
            config = {
                "primary_color": f"#{tenant_id[-6:]}",  # Generate unique color
                "company_name": f"Company {tenant_id}"
            }
            return await engine.apply_customization(tenant_id, "branding", config)
        
        # Test concurrent customizations
        tenant_ids = [f"tenant-{i:03d}" for i in range(10)]
        tasks = [apply_test_customization(tid) for tid in tenant_ids]
        
        start_time = time.time()
        results = await asyncio.gather(*tasks)
        end_time = time.time()
        
        # Should complete within reasonable time
        assert end_time - start_time < 5.0  # 5 seconds for 10 concurrent operations
        assert all(result["status"] == "applied" for result in results)

    def test_enterprise_template_library_management(self):
        """Test managing enterprise template library"""
        from app.services.template_manager import TemplateManager
        
        template_manager = TemplateManager(db_session)
        
        # Create industry-specific templates
        templates = [
            {
                "name": "Luxury Real Estate",
                "industry": "luxury_real_estate",
                "config": {"branding": {"theme": "elegant"}}
            },
            {
                "name": "Commercial Properties",
                "industry": "commercial_real_estate", 
                "config": {"workflow": {"business_focus": True}}
            },
            {
                "name": "Property Management",
                "industry": "property_management",
                "config": {"features": ["maintenance_tracking", "tenant_portal"]}
            }
        ]
        
        created_templates = []
        for template_data in templates:
            template = await template_manager.create_template(template_data)
            created_templates.append(template)
        
        # Test template search and filtering
        luxury_templates = await template_manager.get_templates_by_industry("luxury_real_estate")
        assert len(luxury_templates) >= 1
        assert luxury_templates[0]["name"] == "Luxury Real Estate"

    def test_audit_trail_for_customization_changes(self):
        """Test audit trail creation for customization changes"""
        engine = CustomizationEngine(db_session)
        
        config = {
            "primary_color": "#007bff",
            "company_name": "Test Company"
        }
        
        result = await engine.apply_customization(
            tenant_id="audit-test-tenant",
            category="branding",
            config=config
        )
        
        # Verify audit trail exists (from Story 4.3)
        from app.models.audit import AuditLog
        audit_entries = db_session.query(AuditLog).filter(
            AuditLog.tenant_id == "audit-test-tenant",
            AuditLog.action == "customization_applied"
        ).all()
        
        assert len(audit_entries) >= 1
        assert audit_entries[0].details["category"] == "branding"
```

**API Endpoints:**

```python
# apps/api/app/api/v1/customization.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.database import get_db
from app.services.customization_engine import CustomizationEngine
from app.core.auth import get_current_tenant

router = APIRouter()

@router.post("/apply")
async def apply_customization(
    customization_data: dict,
    db: Session = Depends(get_db),
    tenant_id: str = Depends(get_current_tenant)
):
    """Apply customization to tenant"""
    engine = CustomizationEngine(db)
    
    try:
        result = await engine.apply_customization(
            tenant_id=tenant_id,
            category=customization_data["category"],
            config=customization_data["config"]
        )
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.post("/deploy-template")
async def deploy_template(
    template_data: dict,
    db: Session = Depends(get_db),
    tenant_id: str = Depends(get_current_tenant)
):
    """Deploy customization from template"""
    engine = CustomizationEngine(db)
    
    try:
        result = await engine.deploy_from_template(
            tenant_id=tenant_id,
            template_id=template_data["template_id"],
            overrides=template_data.get("overrides")
        )
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.get("/templates")
async def get_templates(
    industry: str = None,
    db: Session = Depends(get_db)
):
    """Get available customization templates"""
    query = db.query(CustomizationTemplate)
    
    if industry:
        query = query.filter(CustomizationTemplate.industry == industry)
    
    templates = query.all()
    return {"templates": [template.to_dict() for template in templates]}

@router.get("/current")
async def get_current_customizations(
    db: Session = Depends(get_db),
    tenant_id: str = Depends(get_current_tenant)
):
    """Get current tenant customizations"""
    customizations = db.query(TenantCustomization).filter(
        TenantCustomization.tenant_id == tenant_id,
        TenantCustomization.is_active == True
    ).all()
    
    return {
        "customizations": [c.to_dict() for c in customizations]
    }
```

**Performance Metrics:**
- Customization application time: <2 seconds
- Template deployment time: <30 seconds
- CSS generation time: <500ms
- Database query optimization for tenant isolation
- Caching for frequently accessed customization configs

**Success Criteria:**
- ✅ Complete customization engine with branding, workflow, and voice configuration
- ✅ White-label deployment capabilities with custom domains
- ✅ Template library with 5+ industry-specific templates
- ✅ Real-time preview functionality in admin interface
- ✅ Compliance validation for all customizations
- ✅ Audit trail integration from Story 4.3
- ✅ Performance benchmarks met (<2s application time)
- ✅ Enterprise-grade security maintained across all customizations

**Integration Points:**
- Stories 4.1-4.3: Compliance, encryption, and audit systems
- Multi-tenant architecture: Tenant isolation and configuration
- Voice API: ElevenLabs integration with custom voice personalities
- Frontend: Real-time customization preview and management interface

This customization engine enables enterprise clients to fully brand and configure their Seiketsu AI instances while maintaining the security and compliance standards established in previous Epic 4 stories. The system supports rapid deployment through templates and provides extensive white-label capabilities for channel partners.